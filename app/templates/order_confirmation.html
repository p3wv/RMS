{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Order Confirmation{% endblock %}

{% block page_content %}
    <style>
        #delivery-form {
            max-width: 400px;
            margin: 20px auto;
        }

        #paypal-button-container {
            display: grid;
            padding-top: 20px;
        }

        #pay-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
        }

        #pay-button:hover {
            color: red;
        }

        #pay-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #pay-button:hover:disabled {
            color: #333;
        }

        .col-md-4 {
            display: grid;
            padding: 10px;
        }

        #total_amount {
            font-weight: 600;
            font-size: 24px;
        }
    </style>

    <script src="https://www.paypal.com/sdk/js?client-id=AbJITLKvPRfdT6Y3Lcd7VLNLfa45bS8WQWQ7F3_Wq6WJTPlzqZMajdvoAfLuQxps1GJhdNGLAPBNG0_Z&currency=USD"></script>

    <h1>Order Confirmation:</h1>

    <div class="col-md-4">
        {{ wtf.quick_form(form, id='order-form') }}
        <p id="total_amount">Total Amount: ${{ total_amount }}</p>
        <button type="submit" id="pay-button" onclick="startPayPalTransaction()" disabled>Pay with PayPal</button>
        <div id="paypal-button-container"></div>
    </div>

    <script>
        let paypalButtonClicked = false;

        function startPayPalTransaction() {
            if (paypalButtonClicked) {
                return;
            }

            paypalButtonClicked = true;

            let totalAmount = ('{{ total_amount }}');
            if (!totalAmount) {
                console.error('Total amount not found.');
                return;
            }
            paypal.Buttons({
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: totalAmount,
                                currency_code: 'USD'
                            }
                        }]
                    });
                },
                onApprove: function (data, actions) {
                    alert('Payment completed successfully!');
                },
                onError: function (err) {
                    console.error('Error:', err);
                    alert('There was an error processing the payment. Please try again.');
                }
            }).render('#paypal-button-container');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('order-form');
            const payButton = document.getElementById('pay-button');

            form.addEventListener('input', function () {
                payButton.disabled = !form.checkValidity();
            });

            payButton.disabled = !form.checkValidity();
        });
    </script>

{% endblock %}

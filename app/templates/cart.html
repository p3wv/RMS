{% extends "base.html" %}

{% block title %}Your Order{% endblock %}

{% block page_content %}
<style>
    h1 {
        text-align: center;
        font-size: 3.5vw; /* Responsive font size */
        padding-bottom: 2vw; /* Responsive padding */
        border-bottom-color: rgba(163, 50, 50, 0.469);
        border-bottom-style: groove;
        font-weight: 380;
    }

    #cart-list {
        padding-left: 1.5vw; /* Responsive padding */
        padding-right: 1.5vw; /* Responsive padding */
        margin-bottom: 1vw; /* Responsive margin */
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        padding-top: 0.5vw; /* Responsive padding */
        padding-bottom: 0.5vw; /* Responsive padding */
        border-bottom-style: groove;
        border-bottom-color: rgba(255, 255, 255, 0.322);
        border-bottom-width: 1px;
        align-items: center;
    }

    .cart-item img {
        max-width: 100%;
        height: auto;
        width: 75px; /* Maintain old width */
        height: 60px; /* Maintain old height */
        border-radius: 5%;
    }

    p {
        font-weight: 350;
        font-size: 20px;
        font-style: italic;
    }

    .quantity-container {
        display: flex;
        align-items: center;
        font-size: 20px;
        font-weight: bold;
        color: white;
    }

    .quantity-button {
        background-color: tomato;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .quantity-button:hover {
        background-color: red;
    }

    .quantity-display {
        margin: 0 10px;
    }

    .remove-button {
        background-color: tomato;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
        padding: 8px 16px;
        margin-right: 10px;
        transition: background-color 0.3s;
    }

    .remove-button:hover {
        background-color: red;
    }

    .buttons {
        display: flex;
        justify-content: space-between;
        padding-bottom: 5px;
        padding-right: 60px;
        padding-left: 60px;
        position: absolute;
        right: 0;
        left: 0;
        background-color: transparent;
        z-index: 1000;
    }

    .button {
        font-weight: 400;
        font-size: 27px;
        font-style: italic;
        padding: 12px 50px;
        color: tomato;
        text-decoration: none;
        border-radius: 3%;
        background-color: transparent;
        border: 2px solid tomato;
        transition: background-color 0.3s, color 0.3s;
    }

    .button:hover {
        background-color: tomato;
        color: white;
    }

    .back-button {
        font-size: 27px;
        padding: 12px 50px;
        color: white;
        text-decoration: none;
        border-radius: 3%;
    }

    .total-button {
        font-weight: 250;
        font-size: 37px;
        padding: 12px 50px;
        color: greenyellow;
        text-decoration: none;
        border-radius: 3%;
    }

    .back-button:hover {
        color: red;
        text-decoration: none;
    }

    .main-container {
        margin-bottom: 85px;
    }

    .empty-cart-message {
        font-weight: bold;
        color: red;
        text-align: center;
        font-size: 24px;
        margin-top: 20px;
    }

    @media screen and (max-width: 768px) {
        .cart-item img {
            width: 30vw; 
            max-height: 25vw;
        }

        p {
            font-size: 3vw;
        }

        .quantity-container {
            font-size: 3vw;
        }

        .quantity-button {
            padding: 0.5vw 1vw;
        }

        .remove-button {
            font-size: 2.5vw;
            padding: 1vw 2vw;
            margin-right: 1vw;
        }

        .buttons {
            padding-bottom: 0.5vw;
            padding-right: 3vw; 
            padding-left: 3vw; 
        }

        .button {
            font-size: 3vw; 
            padding: 1vw 4vw;
        }

        .back-button {
            font-size: 3vw; 
            padding: 1vw 4vw;
        }

        .total-button {
            font-size: 4vw;
            padding: 1vw 4vw;
        }

        .main-container {
            margin-bottom: 15vw;
        }

        .empty-cart-message {
            font-size: 3vw; 
            margin-top: 4vw; 
        }
    }
</style>

<h1>Your order:</h1>

<div id="cart-list" class="cart-container">
</div>

<div class="buttons">
    <a href="{{ url_for('main.menu') }}" class="back-button"><span>&#8678;</span> BACK TO MENU</a>
    <div class="total-button">TOTAL: $<span id="totalAmount"></span></div>
    <button class="button" onclick="submitOrder()">CHECK, PLEASE! <span>&#10145;</span></button>
</div>

<form id="order-form" method="POST" action="{{ url_for('main.order_confirmation') }}">
    {{ form.csrf_token }}
    <input type="hidden" name="items" id="items">
    <input type="hidden" name="total_amount" id="total-amount">
</form>

<script>

let cartItems = [];

document.addEventListener('DOMContentLoaded', function() {
    displayCart()
});

function displayCart() {
    const cartContainer = document.getElementById('cart-list');
    cartContainer.innerHTML = '';

    cartItems = JSON.parse(localStorage.getItem('cart')) || [];

    if (cartItems.length === 0) {
    cartContainer.innerHTML = '<p>Your cart is empty.</p>';
    return;
    }

    const totalAmount = calculateTotalAmount(cartItems);
    updateTotalAmount(totalAmount);

    cartItems.forEach(cartItemJSON => {
    const cartItem = JSON.parse(cartItemJSON);

    const cartItemDiv = document.createElement('div');
    cartItemDiv.className = 'cart-item';

    if (cartItem.image) {
        const itemImage = document.createElement('img');
        itemImage.src = cartItem.image;
        itemImage.alt = cartItem.name;
        cartItemDiv.appendChild(itemImage);
    }

    const itemNamePrice = document.createElement('p');
    itemNamePrice.textContent = `${cartItem.name} - $${cartItem.price}`;
    cartItemDiv.appendChild(itemNamePrice);

    if (cartItem.quantity) { 
        const quantityContainer = document.createElement('div');
        quantityContainer.className = 'quantity-container';

        const addButton = document.createElement('button');
        addButton.textContent = '+';
        addButton.className = 'quantity-button';
        addButton.addEventListener('click', () => {
        updateQuantity(cartItem.name, 1);
        });

        const minusButton = document.createElement('button');
        minusButton.textContent = '-';
        minusButton.className = 'quantity-button';
        minusButton.addEventListener('click', () => {
        updateQuantity(cartItem.name, -1);
        });

        const quantityDisplay = document.createElement('span');
        quantityDisplay.textContent = cartItem.quantity;

        quantityContainer.appendChild(minusButton);
        quantityContainer.appendChild(quantityDisplay);
        quantityContainer.appendChild(addButton);
        cartItemDiv.appendChild(quantityContainer);
    }

    const removeButton = document.createElement('button');
    removeButton.textContent = 'Remove from cart';
    removeButton.className = 'remove-button';
    removeButton.addEventListener('click', () => {
        removeFromCart(cartItem.name);
    });
    cartItemDiv.appendChild(removeButton);

    cartContainer.appendChild(cartItemDiv);
    });
}



    function updateQuantity(itemName, quantityChange) {
        const foundItemIndex = cartItems.findIndex(item => item.name === itemName);
        if (foundItemIndex !== -1) {
            cartItems[foundItemIndex].quantity += quantityChange;
            if (cartItems[foundItemIndex].quantity <= 0) {
                cartItems.splice(foundItemIndex, 1);
            }
            displayCart(cartItems);
            updateTotalAmount(calculateTotalAmount(cartItems));
        }
    }

    function removeFromCart(itemName) {
        const foundItemIndex = cartItems.findIndex(item => item.name === itemName);
        if (foundItemIndex !== -1) {
            cartItems.splice(foundItemIndex, 1);
            displayCart(cartItems);
            updateTotalAmount(calculateTotalAmount(cartItems));
        }
    }

    function calculateTotalAmount(cartItems) {
        return cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);
    }

    function updateTotalAmount(totalAmount) {
        document.getElementById('total-amount').value = totalAmount;
        document.getElementById('totalAmount').textContent = totalAmount;
    }

    function groupIdenticalItems(cartItems) {
        const groupedItems = {};
        cartItems.forEach(item => {
            if (item && item.name) {
                const itemName = item.name;
                if (groupedItems[itemName]) {
                    groupedItems[itemName].push(item);
                } else {
                    groupedItems[itemName] = [item];
                }
            }
        });
        return Object.values(groupedItems);
    }

    async function submitOrder() {
        const cartItemsJson = JSON.stringify(cartItems);

        document.getElementById('items').value = cartItemsJson;

        const totalAmount = calculateTotalAmount(cartItems);

        document.getElementById('total-amount').value = totalAmount;

        try {
            const response = await fetch('/submit-order', {
            method: 'POST',
            body: JSON.stringify({ cartItems: cartItemsJson, totalAmount: totalAmount }),
            headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
            console.log("Order submitted successfully!");
            } else {
            const errorData = await response.json(); 
            console.error('Error submitting order:', errorData.error || response.statusText);
            }
        } catch (error) {
            console.error('Error sending cart update request:', error);
        }
    }

function emptyCart() {
	if (sessionStorage.getItem('shopping-cart')) {
		sessionStorage.removeItem('shopping-cart');
		showCartTable();
	}
}

function showCartTable() {
	var cartRowHTML = "";
	var itemCount = 0;
	var grandTotal = 0;

	var price = 0;
	var quantity = 0;
	var subTotal = 0;

	if (sessionStorage.getItem('shopping-cart')) {
		var shoppingCart = JSON.parse(sessionStorage.getItem('shopping-cart'));
		itemCount = shoppingCart.length;

		shoppingCart.forEach(function(item) {
			var cartItem = JSON.parse(item);
			price = parseFloat(cartItem.price);
			quantity = parseInt(cartItem.quantity);
			subTotal = price * quantity

			cartRowHTML += "<tr>" +
				"<td>" + cartItem.productName + "</td>" +
				"<td class='text-right'>$" + price.toFixed(2) + "</td>" +
				"<td class='text-right'>" + quantity + "</td>" +
				"<td class='text-right'>$" + subTotal.toFixed(2) + "</td>" +
				"</tr>";

			grandTotal += subTotal;
		});
	}

	$('#cartTableBody').html(cartRowHTML);
	$('#itemCount').text(itemCount);
	$('#totalAmount').text("$" + grandTotal.toFixed(2));
}

</script>
{% endblock %}

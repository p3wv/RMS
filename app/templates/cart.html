{% extends "base.html" %}

{% block title %}Your Order{% endblock %}

{% block page_content %}
    <style>

        h1 {
            display: flex;
            justify-content: center;
            padding-bottom: 20px;
            border-bottom-color: rgba(255, 255, 255, 0.322);
            border-bottom-style: groove;
            font-weight: 380;
        }

        #cart-list {
            padding-left: 15px;
            padding-right: 15px;
            margin-bottom: 10px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            padding-bottom: 15px;
            /* outline-style: ridge; */
            /* outline-color: black; */
            align-items: center; 
        }

        .cart-item img {
            max-width: 100%;
            height: auto;
            width: 100px;
            height: 75px;
        }

        p {
            font-weight: 400;
            font-size: 20px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.71);
        }

        .quantity-input {
            color: white;
            font-size: 45px;
            font-weight: 350;
            background-color: transparent;
            width: 60px; 
        }

        .remove-button {
            background-color: #ff5252a6;
            color: white;
            border: none;
            padding: 0.5%;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-size: 15px;
            width: 3cm;
        }

        .remove-button:hover {
            background-color: #ef1b1b;  /* Darker red on hover */
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            padding-bottom: 15px;
            padding-right: 60px;
            padding-left: 60px;
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background-color: transparent; 
            z-index: 1000;
        }

        .button {
            font-weight: 400;
            font-size: 30px;
            padding: 12px 30px;
            color: red;
            background-color: rgba(0, 0, 0, 0.204);
            text-decoration: none;
            transition: background-color 0.3s;
            border-radius: 3%;
        }

        .button:hover {
            background-color: #333;  
            color: rgb(0, 255, 0);  
            text-decoration: none;
        }

        /* .total {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            width: 30%;
            display: flex;
            /* align-items: flex-end; */
            /* justify-content: center;
            align-items: center;
            padding: 8px 15px;
            margin-bottom: 25px;
            font-size: 40px;
            font-weight: 300;
            font-style: italic;
            color: #ff5252;
            background-color: #333333b9;
        } */

        .main-container {
            margin-bottom: 100px;
        }

    </style>
    
    <div class="main-container">
        <h1>Your order:</h1>
        <div id="cart-list">
            {% for item in cart_items %}
                <div class="cart-item">
                    <img src="{{ item.image }}" alt="{{ item.name }}">
                    <p>{{ item.name }} - ${{ item.price }}</p>
                </div>
            {% endfor %}
        </div>
        
    </div>

    <div class="buttons">
        <a href="{{ url_for('main.menu') }}" class="button"><span>&#8678;</span> BACK TO MENU</a>
        <div class="button">Total: $<span id="totalAmount"></span></div>
        <a href="{{ url_for('main.order_confirmation') }}" class="button" onclick="proceedToCheckout()">CHECKOUT <span>&#10145;</span></a>
    </div>
    
    <script>

        function proceedToCheckout() {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let totalAmount = calculateTotalAmount(cartItems);

            fetch('/save_total_amount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ totalAmount: totalAmount }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                window.location.href = '/order_confirmation';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error processing the order. Please try again.');
            });
        }

        function groupIdenticalItems(items) {
            let groupedItems = [];
            
            items.forEach(item => {
                const existingGroup = groupedItems.find(group => isIdentical(group[0], item));

                if (existingGroup) {
                    existingGroup.push(item);
                } else {
                    groupedItems.push([item]);
                }
            });

            return groupedItems;
        }
    
        function isIdentical(item1, item2) {
            return item1.name === item2.name && item1.price === item2.price;
        }
        function updateQuantity(event, index) {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems[index] = Array(Number(event.target.value)).fill(groupedItems[index][0]);

            let updatedCart = groupedItems.flat();

            localStorage.setItem('cart', JSON.stringify(updatedCart));
            displayCart();
        }
    
        function removeItem(index) {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems.splice(index, 1);

            let updatedCart = groupedItems.flat();

            localStorage.setItem('cart', JSON.stringify(updatedCart));
            displayCart();
        }
    
        function calculateTotalAmount(items) {
            return items.reduce((sum, item) => sum + item.price, 0).toFixed(2);
        }

        function updateTotalAmount() {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let totalAmount = calculateTotalAmount(cartItems);
            document.getElementById('totalAmount').textContent = totalAmount;
        }
    
        function displayCart() {
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';

            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems.forEach((group, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';

                const itemImage = document.createElement('img');
                itemImage.src = group[0].image;
                itemImage.alt = group[0].name;

                const itemName = document.createElement('p');
                itemName.textContent = `${group[0].name} - $${group[0].price}`;

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'quantity-input';
                quantityInput.value = group.length;
                quantityInput.min = '1';
                quantityInput.addEventListener('change', (event) => updateQuantity(event, index));

                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.className = 'remove-button';
                removeButton.addEventListener('click', () => removeItem(index));

                cartItem.appendChild(itemImage);
                cartItem.appendChild(itemName);
                cartItem.appendChild(quantityInput);
                cartItem.appendChild(removeButton);
                cartList.appendChild(cartItem);
            });
            updateTotalAmount();
        }
    
        displayCart();
    </script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Your Order{% endblock %}

{% block page_content %}
    <style>
        .cart-item {
            margin-bottom: 20px;
            text-align: center;
        }

        .cart-item img {
            max-width: 100%;
            height: auto;
            width: 200px;
            height: 150px;
        }

        .quantity-input {
            width: 30px;
            text-align: center;
            margin: 0 10px;
        }

        .checkout {
            display: flex;
            justify-content: end;
            padding-bottom: 10px;
        }

        #checkout-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        #checkout-button:hover {
            color: red;
        }
    </style>
    
    <h1>What you've added to your next order so far:</h1>
    <br>

    <div id="cart-list">
        {% for item in cart_items %}
            <div class="cart-item">
                <img src="{{ item.image }}" alt="{{ item.name }}">
                <p>{{ item.name }} - ${{ item.price }}</p>
            </div>
        {% endfor %}
    </div>

    <div class="checkout">
        <a href="{{ url_for('main.order_confirmation') }}" class="btn btn-primary" style="font-weight: 500; font-size: 20px; padding: 12px 30px;" onclick="proceedToCheckout()">Proceed to Checkout >></a>
    </div>
    
    <script>
        function proceedToCheckout() {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let totalAmount = calculateTotalAmount(cartItems);

            // Send a POST request to the server to save the total amount
            fetch('/save_total_amount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ totalAmount: totalAmount }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Redirect to the order confirmation page
                window.location.href = '/order_confirmation';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error processing the order. Please try again.');
            });
        }

        function groupIdenticalItems(items) {
            let groupedItems = [];
            
            items.forEach(item => {
                const existingGroup = groupedItems.find(group => isIdentical(group[0], item));

                if (existingGroup) {
                    existingGroup.push(item);
                } else {
                    groupedItems.push([item]);
                }
            });

            return groupedItems;
        }
    
        function isIdentical(item1, item2) {
            return item1.name === item2.name && item1.price === item2.price;
        }
        function updateQuantity(event, index) {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems[index] = Array(Number(event.target.value)).fill(groupedItems[index][0]);

            let updatedCart = groupedItems.flat();

            localStorage.setItem('cart', JSON.stringify(updatedCart));
            displayCart();
        }
    
        function removeItem(index) {
            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems.splice(index, 1);

            let updatedCart = groupedItems.flat();

            localStorage.setItem('cart', JSON.stringify(updatedCart));
            displayCart();
        }
    
        function calculateTotalAmount(items) {
            return items.reduce((sum, item) => sum + item.price, 0).toFixed(2);
        }
    
        function displayCart() {
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = '';

            let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let groupedItems = groupIdenticalItems(cartItems);

            groupedItems.forEach((group, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';

                const itemImage = document.createElement('img');
                itemImage.src = group[0].image;
                itemImage.alt = group[0].name;

                const itemName = document.createElement('p');
                itemName.textContent = `${group[0].name} - $${group[0].price}`;

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'quantity-input';
                quantityInput.value = group.length;
                quantityInput.min = '1';
                quantityInput.addEventListener('change', (event) => updateQuantity(event, index));

                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeItem(index));

                cartItem.appendChild(itemImage);
                cartItem.appendChild(itemName);
                cartItem.appendChild(quantityInput);
                cartItem.appendChild(removeButton);
                cartList.appendChild(cartItem);
            });
        }
    
        displayCart();
    </script>

{% endblock %}
